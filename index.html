<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aison Translator — 2-Chiều (VI ↔ EN)</title>
<style>
  :root{--bg:#0b1220;--card:#121a2b;--ink:#eaf2ff;--muted:#9fb2d8;--accent:#5fe1ff}
  html,body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1c);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:28px auto;padding:18px}
  .card{background:var(--card);border:1px solid #1e2a44;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:18px}
  h1{margin:0 0 6px;font-size:26px}
  p.sub{margin:0 0 14px;color:var(--muted)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 16px}
  button{border:0;border-radius:999px;padding:12px 18px;font-weight:700;cursor:pointer}
  .primary{background:linear-gradient(135deg,#1d6aff,#00d0ff);color:#00142a}
  .danger{background:#5b1b1b;color:#fff}
  .badge{display:inline-flex;gap:8px;align-items:center;background:#0f1627;border:1px solid #21365b;color:#cfe2ff;border-radius:12px;padding:8px 12px}
  textarea{width:100%;min-height:110px;background:#0f1627;color:var(--ink);border:1px solid #21365b;border-radius:12px;padding:12px;font-size:15px;resize:vertical}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:840px){.grid{grid-template-columns:1fr}}
  .note{color:#bcd0ff;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Aison Translator</h1>
    <p class="sub">Nói Tiếng Việt ↔ English • Tự phát hiện, tự dịch, tự đọc ra loa • Nghe liên tục</p>

    <div class="controls">
      <button id="btnStart" class="primary">▶ Start</button>
      <button id="btnStop" class="danger">⏹ Stop</button>
      <span class="badge">Mic: <b id="mic">idle</b></span>
      <span class="badge">Status: <b id="status">ready</b></span>
      <span class="badge">
        Tự khởi động lại:
        <input id="autoRestart" type="checkbox" checked style="transform:scale(1.2);margin-left:6px">
      </span>
      <span class="badge">
        Đọc ra loa (TTS):
        <input id="tts" type="checkbox" checked style="transform:scale(1.2);margin-left:6px">
      </span>
    </div>

    <div class="grid">
      <div>
        <label>Nghe / You said</label>
        <textarea id="heard" placeholder="Ứng dụng sẽ hiển thị câu vừa nói ở đây..." readonly></textarea>
      </div>
      <div>
        <label>Dịch / Translation</label>
        <textarea id="out" placeholder="Bản dịch sẽ hiện ở đây..." readonly></textarea>
      </div>
    </div>

    <p class="note" style="margin-top:12px">
      • Bấm <b>Start</b> rồi cho phép <b>micro</b>. Nói từng câu rõ ràng, đợi 1–2 giây để dịch & đọc ra loa.<br>
      • Ứng dụng dùng Google Translate (endpoint miễn phí). Nếu chậm, thử lại trong giây lát.
    </p>
  </div>
</div>

<script>
(() => {
  // --------- Helpers
  const $ = s => document.querySelector(s);
  const micEl = $('#mic'), statusEl = $('#status'), heardEl = $('#heard'), outEl = $('#out');
  const autoRestart = $('#autoRestart'), tts = $('#tts');
  const synth = window.speechSynthesis;

  // Speak text with proper language
  function speak(text, lang) {
    if (!tts.checked || !text) return;
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang; // 'vi-VN' or 'en-US'
      const v = synth.getVoices().find(v => v.lang === lang) ||
                synth.getVoices().find(v => v.lang.startsWith(lang.split('-')[0])) || null;
      if (v) u.voice = v;
      u.rate = 1.0; u.pitch = 1.0;
      synth.cancel();
      synth.speak(u);
    } catch(_) {}
  }

  // Google Translate (unofficial, no key). Auto-detect source, return detected lang.
  async function translateAuto(text, target) {
    // sl=auto để Google tự phát hiện ngôn ngữ đầu vào
    const url = https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(text)};
    try {
      const res = await fetch(url);
      const data = await res.json();
      const translated = (data && data[0] && data[0][0] && data[0][0][0]) ? data[0][0][0] : '';
      // data[2] là mã ngôn ngữ phát hiện, ví dụ 'vi' hoặc 'en'
      const detected = (data && data[2]) ? data[2] : 'auto';
      return { translated, detected };
    } catch (e) {
      console.error(e);
      return { translated: '(Lỗi dịch – thử lại hoặc kiểm tra Internet)', detected: 'auto' };
    }
  }

  // --------- Speech Recognition (continuous)
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Vui lòng dùng Google Chrome/Edge mới để dùng nhận giọng nói.');
    return;
  }
  let recog = null, listening = false;
  let currentRecogLang = 'vi-VN'; // sẽ tự điều chỉnh sau mỗi câu

  function createRecog() {
    const r = new SpeechRecognition();
    r.continuous = true;
    r.interimResults = true;
    r.lang = currentRecogLang;
    r.onstart = () => { listening = true; micEl.textContent = 'listening…'; statusEl.textContent = 'listening…'; };
    r.onerror = (e) => { statusEl.textContent = 'error: ' + (e.error||''); };
    r.onend = () => {
      listening = false; micEl.textContent = 'stopped'; statusEl.textContent = 'stopped';
      if (autoRestart.checked) setTimeout(() => { tryStart(); }, 300);
    };

    let partial = '';
    r.onresult = async (ev) => {
      let finalText = '';
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        const rr = ev.results[i];
        if (rr.isFinal) finalText += rr[0].transcript;
        else partial = rr[0].transcript;
      }
      const show = (finalText || partial).trim();
      if (!show) return;
      heardEl.value = show;

      // Khi có câu hoàn chỉnh -> dịch, nói, và điều chỉnh ngôn ngữ cho vòng sau
      if (finalText) {
        statusEl.textContent = 'translating…';
        // Nhờ Google tự phát hiện ngôn ngữ đầu vào
        let target = 'en'; // mặc định dịch sang EN
        let ttsLang = 'en-US';
        const { translated, detected } = await translateAuto(finalText, target);
        // Nếu Google phát hiện đầu vào là EN -> dịch sang VI
        if (detected && detected.toLowerCase().startsWith('en')) {
          target = 'vi';
          const res2 = await translateAuto(finalText, target);
          outEl.value = res2.translated;
          speak(res2.translated, 'vi-VN');
          // đặt ngôn ngữ nhận dạng vòng tiếp theo về EN
          currentRecogLang = 'en-US';
        } else {
          outEl.value = translated;
          speak(translated, ttsLang);
          currentRecogLang = 'vi-VN';
        }
        statusEl.textContent = 'listening…';

        // Cập nhật lại language cho recognizer lần sau (đổi model)
        try { recog.stop(); } catch(_){}
      }
    };
    return r;
  }

  async function tryStart() {
    if (listening) return;
    if (recog) { try { recog.stop(); } catch(_){ } }
    recog = createRecog();
    recog.lang = currentRecogLang;
    try { recog.start(); } catch(_) {}
  }

  $('#btnStart').onclick = tryStart;
  $('#btnStop').onclick = () => { if (recog) try{ recog.stop(); }catch(_){ } };

  // warm up voices
  if (synth) {
    const preload = () => synth.getVoices();
    preload();
    if (typeof speechSynthesis !== 'undefined') speechSynthesis.onvoiceschanged = preload;
  }
})();
</script>
</body>
</html>
